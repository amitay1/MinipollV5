using UnityEngine;
using UnityEngine.UI;
using System.Collections;

/// <summary>
/// MenuButtonsAnimationController - ×× ×”×œ ××ª ×× ×™××¦×™×•×ª ×”×›×¤×ª×•×¨×™×
/// ×”×× ×™××¦×™×” ××ª×¨×—×©×ª ×¨×§ ×¤×¢× ××—×ª, 2 ×©× ×™×•×ª ××—×¨×™ ×©×•×•×™×“××• ×”××™× ×™×¤×•×œ×™× ××¡×ª×™×™×
/// ×›××• ×›×Ÿ ××˜×¤×œ ×‘×× ×™××¦×™×™×ª ×œ×—×™×¦×” ×¢×œ ×”×›×¤×ª×•×¨×™×
/// </summary>
public class MenuButtonsAnimationController : MonoBehaviour
{
    [Header("Animation Settings")]
    [Tooltip("×–××Ÿ ×”××ª× ×” ××—×¨×™ ×©×•×•×™×“××• ×”××™× ×™×¤×•×œ×™× ××¡×ª×™×™× (×‘×©× ×™×•×ª)")]
    public float delayAfterMinipollVideo = 2f;
    
    [Tooltip("××©×š ×”×× ×™××¦×™×” ×©×œ ×”×•×¤×¢×ª ×”×›×¤×ª×•×¨×™×")]
    public float entranceAnimationDuration = 1.2f;
    
    [Tooltip("×¢×•×¦××ª ××¤×§×˜ ×”×œ×—×™×¦×”")]
    public float clickAnimationScale = 0.9f;
    
    [Tooltip("××©×š ×× ×™××¦×™×™×ª ×”×œ×—×™×¦×”")]
    public float clickAnimationDuration = 0.15f;
    
    [Header("Debug")]
    [Tooltip("×”×•×“×¢×•×ª debug ×‘×§×•× ×¡×•×œ")]
    public bool showDebugMessages = true;
    
    // Variables ×¤×¨×˜×™×•×ª
    // private EntranceSequenceManager entranceManager; // Commented out - not used in current version
    private Animator buttonAnimator;
    private Button[] menuButtons;
    private bool animationTriggered = false;
    private bool isMinipollVideoFinished = false;
    
    void Start()
    {
        // Temporarily disabled - EntranceSequenceManager handles all animation now
        Debug.Log("MenuButtonsAnimationController temporarily disabled");
        return;
        
        /*
        // ××¦× ××ª ×”-EntranceSequenceManager
        entranceManager = FindFirstObjectByType<EntranceSequenceManager>();
        if (entranceManager == null)
        {
            Debug.LogError("âŒ MenuButtonsAnimationController: ×œ× × ××¦× EntranceSequenceManager!");
            return;
        }
        
        // ×§×‘×œ ××ª ×”×× ×™××˜×•×¨ ×©×”×•×¡×¤× ×• ×œ-MenuButtons
        buttonAnimator = GetComponent<Animator>();
        if (buttonAnimator == null)
        {
            Debug.LogError("âŒ MenuButtonsAnimationController: ×œ× × ××¦× Animator component!");
            return;
        }
        
        // ××¦× ××ª ×›×œ ×”×›×¤×ª×•×¨×™×
        menuButtons = GetComponentsInChildren<Button>();
        if (showDebugMessages)
        {
            Debug.Log($"ğŸ¯ MenuButtonsAnimationController: × ××¦××• {menuButtons.Length} ×›×¤×ª×•×¨×™×");
        }
        
        // ×”×•×¡×£ listeners ×œ×›×¤×ª×•×¨×™× ×œ×× ×™××¦×™×™×ª ×œ×—×™×¦×”
        SetupButtonClickAnimations();
        
        // ×”×ª×—×œ ×œ×‘×“×•×§ ××ª×™ ×•×•×™×“××• ×”××™× ×™×¤×•×œ×™× ××¡×ª×™×™×
        StartCoroutine(CheckForMinipollVideoEnd());
        
        if (showDebugMessages)
        {
            Debug.Log("âœ… MenuButtonsAnimationController ××•×›×Ÿ!");
        }
        */
    }
    
    void SetupButtonClickAnimations()
    {
        foreach (Button button in menuButtons)
        {
            if (button != null)
            {
                // ×”×•×¡×£ event ×œ×›×œ ×›×¤×ª×•×¨
                button.onClick.AddListener(() => OnButtonClick(button));
                
                if (showDebugMessages)
                {
                    Debug.Log($"ğŸ”§ ×”×•×¡×£ ×× ×™××¦×™×™×ª ×œ×—×™×¦×” ×œ×›×¤×ª×•×¨: {button.name}");
                }
            }
        }
    }
    
    IEnumerator CheckForMinipollVideoEnd()
    {
        if (showDebugMessages)
        {
            Debug.Log("ğŸ” ××ª×—×™×œ ×œ×‘×“×•×§ ××ª×™ ×•×•×™×“××• ×”××™× ×™×¤×•×œ×™× ××¡×ª×™×™×...");
        }
        
        // ×—×›×” ×¢×“ ×©×”-EntranceSequenceManager ×™×ª×—×™×œ
        while (entranceManager == null)
        {
            yield return new WaitForSeconds(0.1f);
        }
        
        // ×‘×“×•×§ ×›×œ ×”×–××Ÿ ××ª ××¦×‘ ×”×•×•×™×“××•
        while (!animationTriggered)
        {
            // ×‘×“×•×§ ×× ×× ×—× ×• ×‘×•×•×™×“××• ×”×©× ×™ (minipollVideo) 
            // ×•×§×™×‘×œ× ×• ××™× ×“×™×§×¦×™×” ×©×”×•× ×”×¡×ª×™×™×
            if (IsMinipollVideoFinished())
            {
                if (showDebugMessages)
                {
                    Debug.Log("ğŸ¬ ×•×•×™×“××• ×”××™× ×™×¤×•×œ×™× ×”×¡×ª×™×™×! ××ª×—×™×œ ×¡×¤×™×¨×” ×œ××—×•×¨...");
                }
                
                // ×—×›×” ××ª ×”×–××Ÿ ×©×”×’×“×¨× ×•
                yield return new WaitForSeconds(delayAfterMinipollVideo);
                
                // ×”×¤×¢×œ ××ª ×”×× ×™××¦×™×” (×¨×§ ×¤×¢× ××—×ª!)
                TriggerButtonsEntrance();
                animationTriggered = true;
                break;
            }
            
            yield return new WaitForSeconds(0.1f); // ×‘×“×•×§ ×›×œ 100ms
        }
    }
    
    bool IsMinipollVideoFinished()
    {
        // ×›××Ÿ ×× ×—× ×• ×‘×•×“×§×™× ×× ×•×•×™×“××• ×”××™× ×™×¤×•×œ×™× ×”×¡×ª×™×™×
        // ××¤×©×¨ ×œ×¢×©×•×ª ×–××ª ×¢×œ ×™×“×™ ×‘×“×™×§×ª currentVideoIndex ××• ×©×™×˜×•×ª ××—×¨×•×ª
        
        // ×× ×—× ×• × ×‘×“×•×§ ×× ×”×¨×¦×£ ×”×•×©×œ× ×•×”×ª×¤×¨×™×˜ ××•×¦×’
        // ×–×” ××•××¨ ×©×›×œ ×”×•×•×™×“××• ×”×¡×ª×™×™××•
        try
        {
            // ×’×™×©×” ×œ×©×“×” ×¤×¨×˜×™ ×©×œ EntranceSequenceManager
            var sequenceCompleteField = typeof(EntranceSequenceManager).GetField("sequenceComplete", 
                System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
            
            if (sequenceCompleteField != null)
            {
                bool sequenceComplete = (bool)sequenceCompleteField.GetValue(entranceManager);
                
                // ×’× × ×‘×“×•×§ ××ª currentVideoIndex
                var videoIndexField = typeof(EntranceSequenceManager).GetField("currentVideoIndex", 
                    System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
                
                if (videoIndexField != null)
                {
                    int currentVideoIndex = (int)videoIndexField.GetValue(entranceManager);
                    
                    if (showDebugMessages && !isMinipollVideoFinished)
                    {
                        Debug.Log($"ğŸ” Video Index: {currentVideoIndex}, Sequence Complete: {sequenceComplete}");
                    }
                    
                    // ×•×•×™×“××• ×”××™× ×™×¤×•×œ×™× ×”×¡×ª×™×™× ××:
                    // 1. ×× ×—× ×• ×‘×•×•×™×“××• 1 (×”×©× ×™) ××• ×™×•×ª×¨
                    // 2. ×”×¨×¦×£ ×”×•×©×œ×
                    bool finished = currentVideoIndex >= 1 && sequenceComplete;
                    
                    if (finished && !isMinipollVideoFinished)
                    {
                        isMinipollVideoFinished = true;
                        if (showDebugMessages)
                        {
                            Debug.Log("ğŸ¯ ×–×•×”×” ×¡×™×•× ×•×•×™×“××• ×”××™× ×™×¤×•×œ×™×!");
                        }
                    }
                    
                    return finished;
                }
            }
        }
        catch (System.Exception e)
        {
            if (showDebugMessages)
            {
                Debug.LogWarning($"âš ï¸ ×©×’×™××” ×‘×‘×“×™×§×ª ××¦×‘ ×”×•×•×™×“××•: {e.Message}");
            }
        }
        
        return false;
    }
    
    void TriggerButtonsEntrance()
    {
        if (showDebugMessages)
        {
            Debug.Log("ğŸ­ ××¤×¢×™×œ ×× ×™××¦×™×™×ª ×›× ×™×¡×” ××’× ×™×‘×” ×œ×›×¤×ª×•×¨×™×!");
        }
        
        // ×”×¤×¢×œ ××ª ×”×× ×™××¦×™×” ×“×¨×š ×”×× ×™××˜×•×¨
        if (buttonAnimator != null)
        {
            buttonAnimator.SetTrigger("StartEntrance");
        }
        
        // ×’× × ×¤×¢×™×œ ×× ×™××¦×™×” ×§×•×“-based ×‘×ª×•×¨ backup
        StartCoroutine(BeautifulEntranceAnimation());
    }
    
    IEnumerator BeautifulEntranceAnimation()
    {
        if (showDebugMessages)
        {
            Debug.Log("âœ¨ ××ª×—×™×œ ×× ×™××¦×™×” ××§×•×“×“×ª ×©×œ ×›× ×™×¡×ª ×”×›×¤×ª×•×¨×™×");
        }
        
        // ×”×ª×—×œ ×¢× ×›×¤×ª×•×¨×™× ×‘×œ×ª×™ × ×¨××™×
        RectTransform rectTransform = GetComponent<RectTransform>();
        Vector3 originalScale = rectTransform.localScale;
        Vector3 originalPosition = rectTransform.localPosition;
        
        // ××¦×‘ ×”×ª×—×œ×ª×™ - ×§×˜×Ÿ ×•×—×“×•×“
        rectTransform.localScale = Vector3.zero;
        rectTransform.localPosition = originalPosition + Vector3.down * 200f;
        
        CanvasGroup canvasGroup = GetComponent<CanvasGroup>();
        if (canvasGroup == null)
            canvasGroup = gameObject.AddComponent<CanvasGroup>();
        
        canvasGroup.alpha = 0f;
        
        // ×× ×™××¦×™×” ×™×¤×” ×¢× ×›××” ×©×œ×‘×™×
        float time = 0f;
        
        while (time < entranceAnimationDuration)
        {
            time += Time.deltaTime;
            float progress = time / entranceAnimationDuration;
            
            // Easing ×¢× bounce effect
            float easedProgress = EaseOutBack(progress);
            
            // Scale animation
            rectTransform.localScale = Vector3.Lerp(Vector3.zero, originalScale, easedProgress);
            
            // Position animation
            rectTransform.localPosition = Vector3.Lerp(
                originalPosition + Vector3.down * 200f, 
                originalPosition, 
                easedProgress
            );
            
            // Alpha animation
            canvasGroup.alpha = Mathf.Lerp(0f, 1f, progress);
            
            yield return null;
        }
        
        // ×•×•×“× ×©×”×¢×¨×›×™× ×”×¡×•×¤×™×™× × ×›×•× ×™×
        rectTransform.localScale = originalScale;
        rectTransform.localPosition = originalPosition;
        canvasGroup.alpha = 1f;
        
        if (showDebugMessages)
        {
            Debug.Log("ğŸ‰ ×× ×™××¦×™×™×ª ×›× ×™×¡×ª ×”×›×¤×ª×•×¨×™× ×”×•×©×œ××”!");
        }
    }
    
    float EaseOutBack(float t)
    {
        const float c1 = 1.70158f;
        const float c3 = c1 + 1f;
        
        return 1f + c3 * Mathf.Pow(t - 1f, 3f) + c1 * Mathf.Pow(t - 1f, 2f);
    }
    
    void OnButtonClick(Button button)
    {
        if (showDebugMessages)
        {
            Debug.Log($"ğŸ‘† × ×œ×—×¥ ×›×¤×ª×•×¨: {button.name}");
        }
        
        // ×”×¤×¢×œ ×× ×™××¦×™×™×ª ×œ×—×™×¦×”
        StartCoroutine(ButtonClickAnimation(button));
    }
    
    IEnumerator ButtonClickAnimation(Button button)
    {
        RectTransform buttonRect = button.GetComponent<RectTransform>();
        Vector3 originalScale = buttonRect.localScale;
        
        // ×× ×™××¦×™×” ×©×œ ×›× ×™×¡×” ×¤× ×™××”
        float time = 0f;
        
        // ×©×œ×‘ 1: ×”×§×˜×Ÿ ×”×›×¤×ª×•×¨
        while (time < clickAnimationDuration)
        {
            time += Time.deltaTime;
            float progress = time / clickAnimationDuration;
            
            float scale = Mathf.Lerp(1f, clickAnimationScale, progress);
            buttonRect.localScale = originalScale * scale;
            
            yield return null;
        }
        
        // ×©×œ×‘ 2: ×”×—×–×¨ ×œ×’×•×“×œ ×”××§×•×¨×™
        time = 0f;
        while (time < clickAnimationDuration)
        {
            time += Time.deltaTime;
            float progress = time / clickAnimationDuration;
            
            float scale = Mathf.Lerp(clickAnimationScale, 1f, progress);
            buttonRect.localScale = originalScale * scale;
            
            yield return null;
        }
        
        // ×•×•×“× ×©×—×–×¨ ×œ×’×•×“×œ ×”××§×•×¨×™
        buttonRect.localScale = originalScale;
        
        if (showDebugMessages)
        {
            Debug.Log($"âœ… ×× ×™××¦×™×™×ª ×œ×—×™×¦×” ×”×•×©×œ××” ×¢×‘×•×¨ {button.name}");
        }
    }
    
    void OnDestroy()
    {
        // × ×§×” ××ª ×”-listeners
        if (menuButtons != null)
        {
            foreach (Button button in menuButtons)
            {
                if (button != null)
                {
                    button.onClick.RemoveAllListeners();
                }
            }
        }
        
        if (showDebugMessages)
        {
            Debug.Log("ğŸ§¹ MenuButtonsAnimationController × ×•×§×”");
        }
    }
}
